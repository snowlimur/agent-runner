version: v2
entry: prepare_branch

defaults:
  model: opus
  agent_idle_timeout_sec: 1800
  command_timeout_sec: 20

limits:
  max_iterations: 300
  max_same_node_hits: 200

nodes:
  prepare_branch:
    run:
      kind: command
      cmd: "node ./pipelines/scripts/prepare-branch.js {{TASK}}"
      cwd: "."
    transitions:
      - when: "run.exit_code == 0"
        to: issue_gate

  issue_gate:
    run:
      kind: command
      cmd: "node ./pipelines/scripts/issue-gate.js"
      cwd: "."
    transitions:
      - when: "run.exit_code == 0"
        to: planner
      - when: "run.exit_code != 0"
        to: fail

  planner:
    run:
      kind: agent
      prompt: "/go-planner {{TASK}}"
      decision:
        schema_file: ./pipelines/schemas/planner.schema.json
    transitions:
      - when: 'run.status == "error"'
        to: fail
      - when: 'decision.status == "failed"'
        to: fail
      - when: 'decision.status == "done"'
        to: implementer
      - when: 'decision.status == "created"'
        to: implementer

  implementer:
    run:
      kind: agent
      prompt: "/go-tdd-implementer {{TASK}}"
      decision:
        schema_file: ./pipelines/schemas/implementer.schema.json
    transitions:
      - when: 'decision.status == "failed"'
        to: fail
      - when: 'decision.status == "todo_missing"'
        to: fail
      - when: 'decision.status == "todo_not_empty"'
        to: implementer
      - when: 'decision.status == "done"'
        to: success

  reviewer:
    run:
      kind: agent
      prompt: "/go-code-reviewer {{TASK}}"
      decision:
        schema_file: ./pipelines/schemas/reviewer.schema.json
    transitions:
      - when: 'decision.status == "fixes_needed"'
        to: implementer
      - when: 'decision.status == "done"'
        to: success
